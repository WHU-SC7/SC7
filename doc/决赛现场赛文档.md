# 决赛线下赛文档


## 问题一 内存重映射问题

现场赛的用户程序出现了mmap请求的地址为p->sz内的情况，针对这种情况调整了vma的分配策略，如果出现这种情况则自动修改mmap分配的首地址，从而消除pte remap的panic

mmap对于map_fixed标志，若映射的位置已经被映射，需要取消原来的映射重新映射一段
## 问题二 动态链接问题

在执行`git help`的时候，发现问题

````
Error loading shared library libpcre2-8.so.0: Exec format error (needed by /usr/bin/git)
````
将磁盘挂载到本地，通过`ls -al`发现`libpcre2-8.so.0`为符号链接文件，实际上指向文件`libpcre2-8.so.0.12.0`，而我们的内核在read的时候并未处理这种情况，所以导致了他读取的内容并不是实际动态链接的内容，而是符号链接内容`libpcre2-8.so.0`。因此，在VFS层做出操作，当读取符号链接的时候，实际上传入lwext4层的path是实际文件路径。

而这导致了第二个问题，移动文件pos的时候，我们只考虑了VFS层file的移动，我们底层文件系统移植的是lwext4，该层次的file的pos并没有实际发生改变。这就导致了`git`认为文件尚未读取结束，一直重复read。因此，需要在lwext4层对文件pos进行操作。现在，动态链接文件就可以了。

## 上板工作
决赛开发工作从下面的提交开始：

Commit: 28aab5756d26f729c297f75c9ab102ea99f13ace
Parents: a5c1960d0ac01a79cb87852d4adeab7406bba2ad
Author: Bandiera Rossa <T202410486994498@eduxiji.net>
Committer: Bandiera Rossa <T202410486994498@eduxiji.net>
Date: Wed Aug 20 2025 08:41:20 GMT+0800 (中国标准时间)


尝试动态链接

决赛镜像提供的程序都是动态链接的，位置也有所变动。所以在物理开发板需要重新适配
而原来的上板分支VisionFive偏离主分支较远，合并困难。在几次尝试后决定在主分支重新适配物理开发板，主要根据原来的适配过程

队友在支持决赛的动态链接时，我提交了3个commit，逐步支持了在VisionFive上执行最新的内核
第一个commit再次支持虚拟内存和用户程序
第二个commit再次支持sd卡驱动
第三个commit再次支持文件系统和shell，具备完整的功能

然后merge队友的能跑决赛测例的分支，实现了在板子上也能运行决赛测试

## 困难总结
1. 内核数据结构显式初始化
qemu和物理板的运行环境是完全不同的，最重要的一点是：内核数据结构要显式初始化！不能默认初始值为0
上文的第三个commit(Commit: 79cdb7)添加了多处内核数据结构的初始化置0,否则未定义的值会造成预期之外的错误

2. 新标准可能导致旧版本不兼容
还有，支持新标准可能会导致旧版本不兼容。以console字符设备文件为例，内核新标准的dev位为了区别主设备和从设备号，使用了新的布局，与老版本不同，导致原来sd卡中console文件的dev读取出来是0，sys_write和sys_read都异常。
修正办法是重新刷写sd卡，删除老console文件，然后让内核创建新标准的console文件，之后就正常了

3. 拆分问题以降低复杂度
最后，拆分对解决复杂问题是非常有用的。上面提到的问题，通过在主分支逐步按原来的提交重新上板的方法，把上面的诸多问题拆分成3次解决。逐步排查问题，每次提交解决一个方面的问题。
如果换成在VisionFive分支直接merge主分支，就要一次性解决上面所有问题(多处未初始化，新字符设备文件，多处冲突)，难以调试，难度指数级增长

4. 分支管理建议
开发过程中分支不宜脱离太久，否则想要merge时，解决冲突非常困难；更改和新增的文件多了，错误难以定位

5. 初赛的问题不能遗留到决赛