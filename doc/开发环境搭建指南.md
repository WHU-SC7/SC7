# 开发环境搭建指南
本文档适用于`x86_64`架构的`Ubuntu`系统
## 一、创建目录结构
```bash
sudo mkdir /toolchains #文件下载保存位置
sudo mkdir -p /opt/toolchains #工具链安装位置
sudo chown -R $USER:$USER /opt/toolchains
```

## 二、工具下载
在[大赛官方评测镜像](https://gitlab.educg.net/wangmingjian/os-contest-2024-image/)中下载:
1. kendryte-toolchain/ 文件夹
2. gcc-13.2.0-loongarch64-linux-gnu.tgz
3. qemu-9.2.1.tar.xz

## 三、安装编译工具链
### 1. 安装Riscv工具
```bash
# 安装基本依赖
sudo apt update sudo apt install -y \ build-essential git autoconf automake autotools-dev curl \ libmpc-dev libmpfr-dev libgmp-dev gawk bison flex texinfo \ gperf libtool patchutils bc zlib1g-dev libexpat-dev \ libglib2.0-dev libpixman-1-dev ninja-build pkg-config \ libslirp-dev python3 python3-pip python3-venv

# 安装riscv64-unknown-elf-gcc
sudo mv kendryte-toolchain/ /opt/toolchains/
cd /opt/toolchains/kendryte-toolchain/bin
chmod +x riscv64-unknown-elf-gcc   #直接使用kendryte-toolchain下的riscv64-unknown-elf-gcc
echo 'export PATH=/opt/toolchains/kendryte-toolchain/bin:$PATH' >> ~/.bashrc #将PATH写入bashrc

```

### 2. 安装Loongarch工具
```bash
mv gcc-13.2.0-loongarch64-linux-gnu.tgz  /toolchains
sudo tar -xzf /toolchains/gcc-13.2.0-loongarch64-linux-gnu.tgz -C /opt/toolchains/ #解压loongarch编译工具
echo 'export PATH=/opt/toolchains/gcc-13.2.0-loongarch64-linux-gnu/bin:$PATH' >> ~/.bashrc #写入环境变量
```

## 四、安装qemu
```bash
# 安装依赖
sudo apt update sudo apt install -y git build-essential ninja-build pkg-config \ libglib2.0-dev libpixman-1-dev libslirp-dev

# 解压工具
mv qemu-9.2.1.tar.xz  /toolchains
tar -xf /toolchains/qemu-9.2.1.tar.xz
cd qemu-9.2.1 ./configure --prefix=/opt/toolchains/qemu-bin/9.2.1 \ --target-list=loongarch64-softmmu,riscv64-softmmu,aarch64-softmmu,x86_64-softmmu \ --enable-slirp # 将工具安装在/opt/toolchains下 配置安装参数
make -j$(nproc) 
make install

echo 'export PATH=/opt/toolchains/qemu-bin/9.2.1/bin:$PATH' >> ~/.bashrc #写入环境变量
```

## 五、验证安装版本
```bash
source ~/.bashrc
riscv64-unknown-elf-gcc --version
# riscv64-unknown-elf-gcc (GCC) 8.2.0
loongarch64-linux-gnu-gcc --version
# loongarch64-linux-gnu-gcc (GCC) 13.2.0
qemu-system-riscv64 --version
# QEMU emulator version 9.2.1
qemu-system-loongarch64 --version
# QEMU emulator version 9.2.1
```

## 六、安装GDB
在[LoongsonLab](https://github.com/LoongsonLab/oscomp-toolchains-for-oskernel)下载`loongarch64-linux-gnu-gdb`

在[riscv-gnu-toolchain Releases](https://github.com/riscv-collab/riscv-gnu-toolchain/releases)下载riscv64-elf-ubuntu-*
`gdb的版本无所谓，能用就行（版本不能太低）`

## 七、配置vscode脚本
在项目的.vscode下创建launch.json和tasks.json
```json 
// launch.json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "la-debug",
      "type": "cppdbg",
      "request": "launch",
      "args": [],
      "stopAtEntry": false,
      "externalConsole": false,
      "cwd": "${workspaceFolder}",
      "program": "build/loongarch/kernel-la",
      "MIMode": "gdb",
      "miDebuggerPath": "loongarch64-linux-gnu-gdb", //替换为自己的gdb路径
      "miDebuggerServerAddress": "localhost:1234",
      "setupCommands": [
        {
          "description": "Enable pretty-printing for gdb",
          "text": "-enable-pretty-printing",
          "ignoreFailures": true
        },
        // {
        //   "description": "Load Symbol File",
        //   "text": "add-symbol-file /home/ly/Desktop/os2025/user/build/loongarch/user.out 0x0",
        //   "ignoreFailures": false
        // }, //调试用户程序使用 路径替换为自己的build下user.out路径
        //  {
        //   "description": "Load Glibc Busybox Symbols",
        //   "text": "add-symbol-file /home/ly/Desktop/os2025/tmp/cases/busybox_unstripped_la_glibc",
        //   "ignoreFailures": false
        // }, //调试busybox使用，路径替换为自己编译出带调试信息的busybox elf路径
        // {
        //   "description": "Set Source Path Substitute",
        //   "text": "set substitute-path /home/lu/testsuit /home/ly",
        //   "ignoreFailures": false
        // }  
        //使用add-symbol-file 加载想要调试的elf
        //通过info sources查看elf路径，将其前缀替换为本地路径前缀
      ]
    },
    {
      "name": "rv-debug",
      "type": "cppdbg",
      "request": "launch",
      "args": [],
      "stopAtEntry": false,
      "externalConsole": false,
      "cwd": "${workspaceFolder}",
      "program": "build/riscv/kernel-rv",
      "MIMode": "gdb",
      "miDebuggerPath": "riscv64-unknown-elf-gdb", //替换为自己的gdb路径
      "miDebuggerServerAddress": "localhost:1234",
      "setupCommands": [
        {
          "description": "Enable pretty-printing for gdb",
          "text": "-enable-pretty-printing",
          "ignoreFailures": true
        },
        // {
        //   "description": "Load Symbol File",
        //   "text": "add-symbol-file /home/ly/Desktop/os2025/user/build/riscv/user.out 0x0",
        //   "ignoreFailures": false
        // },
        // {
        //   "description": "Load glibc ltp",
        //   "text": "add-symbol-file /mnt/glibc/ltp/testcases/bin/shmctl01",
        //   "ignoreFailures": true
        // },
        // {
        //   "description": "Load Glibc Busybox Symbols",
        //   "text": "add-symbol-file /home/ly/Desktop/os2025/tmp/cases/busybox_unstripped_glibc",
        //   "ignoreFailures": false
        // },
        // {
        //   "description": "Load Musl Busybox Symbols",
        //   "text": "add-symbol-file /home/ly/Desktop/os2025/tmp/cases/busybox_unstripped_musl",
        //   "ignoreFailures": false
        // },
        // {
        //   "description": "Set Source Path Substitute",
        //   "text": "set substitute-path /code /home/ly/testsuits-for-oskernel",
        //   "ignoreFailures": false
        // }
      ]
    },
    {
      "name": "C/C++ Runner: Debug Session",
      "type": "cppdbg",
      "request": "launch",
      "args": [],
      "stopAtEntry": false,
      "externalConsole": false,
      "cwd": "/home/ly/桌面/os2025/kernel",
      "program": "/home/ly/桌面/os2025/kernel/build/Debug/outDebug",
      "MIMode": "gdb",
      "miDebuggerPath": "gdb",
      "setupCommands": [
        {
          "description": "Enable pretty-printing for gdb",
          "text": "-enable-pretty-printing",
          "ignoreFailures": true
        },
      ]
    }
  ]
}
```

```json
// tasks.json
{
    "version": "2.0.0",
    "tasks": [
        {
            "label": "make clean",
            "type": "shell",
            "command": "make",
            "args": ["clean"],
            "group": "build",
            "problemMatcher": [],
            "options": {
                "cwd": "${workspaceFolder}"
            }
        },
        {
            "label": "make sbi",
            "type": "shell",
            "command": "make",
            "args": ["sbi"],
            "dependsOn": ["make clean"],  // 声明依赖项，先执行 clean
            "group": {
                "kind": "build",
                "isDefault": true        // 设为默认任务（可选）
            },
            "problemMatcher": [],
            "options": {
                "cwd": "${workspaceFolder}"
            },
            "presentation": {
                "reveal": "always",
                "panel": "shared"
            }
        },
        {
            "label": "make la",
            "type": "shell",
            "command": "make",
            "args": ["docker_la"],
            "dependsOn": ["make clean"],  // 声明依赖项，先执行 clean
            "group": {
                "kind": "build",
                "isDefault": true        // 设为默认任务（可选）
            },
            "problemMatcher": [],
            "options": {
                "cwd": "${workspaceFolder}"
            },
            "presentation": {
                "reveal": "always",
                "panel": "shared"
            }
        },
        {
            "label": "make rv qemu",
            "type": "shell",
            "command": "make",
            "args": ["sbi_qemu"],
            "dependsOn": ["make sbi"],  // 声明依赖项，先执行 clean
            "group": {
                "kind": "build",
                "isDefault": true        // 设为默认任务（可选）
            },
            "problemMatcher": [],
            "options": {
                "cwd": "${workspaceFolder}"
            },
            "presentation": {
                "reveal": "always",
                "panel": "shared"
            }
        },
        {
            "label": "make la qemu",
            "type": "shell",
            "command": "make",
            "args": ["virt"],
            "dependsOn": ["make la"],  // 声明依赖项，先执行 clean
            "group": {
                "kind": "build",
                "isDefault": true        // 设为默认任务（可选）
            },
            "problemMatcher": [],
            "options": {
                "cwd": "${workspaceFolder}"
            },
            "presentation": {
                "reveal": "always",
                "panel": "shared"
            }
        },

    ]
}
```

配置完成后，可通过vscode ctrl+shift+P运行`make rv qemu`或`make la qemu`编译并运行qemu,选择对应的调试任务`rv-debug`或`la-debug`调试即可
